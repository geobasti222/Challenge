# API Management Setup Tasks
steps:
- task: AzureCLI@2
  displayName: 'Setup API Management Service'
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      echo "=== CONFIGURANDO API MANAGEMENT ==="
      
      # Verificar si el API Management Service existe
      if az apim show --name $(apimServiceName) --resource-group $(apimResourceGroup) &>/dev/null; then
        echo "✅ API Management Service ya existe"
        APIM_STATUS=$(az apim show --name $(apimServiceName) --resource-group $(apimResourceGroup) --query "provisioningState" -o tsv)
        echo "Estado del APIM: $APIM_STATUS"
      else
        echo "📝 Creando nuevo API Management Service..."
        az apim create \
          --name $(apimServiceName) \
          --resource-group $(apimResourceGroup) \
          --publisher-email "$(apimPublisherEmail)" \
          --publisher-name "$(apimPublisherName)" \
          --sku-name "$(apimSku)" \
          --location "eastus" \
          --no-wait
        echo "⏳ API Management Service en proceso de creación..."
      fi