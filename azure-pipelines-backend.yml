# create-storage-canada.yml
trigger: none
pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  resourceGroupName: 'TerraformStateResourceGroup'
  containerName: 'tfstate'
  location: 'canadacentral'  # ‚Üê Regi√≥n que S√ç te funciona

steps:
- task: AzureCLI@2
  displayName: 'Create Storage Account in Canada Central'
  inputs:
    azureSubscription: 'MychallengeServiceConnection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      
      echo "=== Usando regi√≥n: $(location) ==="
      az account show
      
      echo "=== Creando Storage Account en Canad√° ==="
      TIMESTAMP=$(date +%s)
      STORAGE_NAME="tfstate$TIMESTAMP"
      echo "Nuevo Storage Account: $STORAGE_NAME"
      
      # Crear Resource Group en Canad√°
      az group create --name $(resourceGroupName) --location $(location) --tags Region=Canada || echo "RG ya existe"
      
      # Crear Storage Account en Canad√°
      az storage account create \
        --resource-group $(resourceGroupName) \
        --name $STORAGE_NAME \
        --sku Standard_LRS \
        --encryption-services blob \
        --location $(location) \
        --allow-blob-public-access false
      
      echo "Esperando a que el Storage Account est√© listo..."
      sleep 30
      
      # Crear container
      az storage container create \
        --name $(containerName) \
        --account-name $STORAGE_NAME \
        --auth-mode login
      
      echo ""
      echo "=== ‚úÖ STORAGE ACCOUNT CREADO EN CANAD√Å ==="
      echo "Resource Group: $(resourceGroupName)"
      echo "Storage Account: $STORAGE_NAME" 
      echo "Container: $(containerName)"
      echo "Location: $(location)"
      echo ""
      echo "=== üîß ACTUALIZA TU PIPELINE ==="
      echo "Variable: tfBackendStorage = $STORAGE_NAME"

- task: Bash@3
  displayName: 'Mostrar valores'
  inputs:
    targetType: 'inline'
    script: |
      echo "Storage Account creado exitosamente en Canad√°"